# Пример диалога с AI: экспорт PDF

> Детальный пример того, как AI помогает с декомпозицией задачи, выбором методов и выявлением рисков на этапе планирования.

---

## Исходная задача

**Пользователь:** Нужно сделать экспорт отчёта в PDF в админке. Как лучше это реализовать?

---

## Диалог с AI

### Шаг 1: Декомпозиция задачи

**AI:** Давайте разложим задачу "экспорт PDF" на подзадачи. Вот что я вижу:

**Подзадачи:**
1. **UI компонент** — кнопка экспорта с прогресс-баром
2. **API эндпоинт** — `/api/reports/export` с валидацией параметров
3. **Выбор метода генерации** — библиотека или headless браузер
4. **Права доступа** — проверка ролей пользователя
5. **Очередь задач** — для тяжёлой генерации PDF
6. **Обработка ошибок** — ретраи и fallback
7. **Логирование и метрики** — для мониторинга
8. **Тестирование** — на разных типах данных

**Вопросы для уточнения:**
- Какой максимальный размер отчёта?
- Сколько пользователей могут экспортировать одновременно?
- Нужна ли поддержка мобильных устройств?
- Какие форматы данных в отчёте (таблицы, графики, текст)?

---

### Шаг 2: Выбор методов генерации

**Пользователь:** Отчёт содержит таблицы с данными и простые графики. Размер до 50 страниц.

**AI:** Для таких требований рассмотрим три подхода:

**1. Puppeteer + HTML/CSS**
- ✅ Точный рендер, поддержка CSS, графики через Chart.js
- ✅ Легко стилизовать под дизайн-систему
- ❌ Тяжёлый (Chrome), медленный старт
- ❌ Высокое потребление памяти

**2. PDFKit (Node.js)**
- ✅ Быстрый, низкое потребление памяти
- ✅ Программное создание PDF
- ❌ Сложная вёрстка таблиц
- ❌ Нет встроенной поддержки графиков

**3. wkhtmltopdf**
- ✅ Компромисс между скоростью и возможностями
- ✅ Поддержка HTML/CSS
- ❌ Зависимость от внешней библиотеки
- ❌ Ограниченная поддержка современных CSS

**Рекомендация:** Puppeteer для сложных отчётов с графиками, PDFKit для простых таблиц.

---

### Шаг 3: Выявление узких мест

**AI:** Заранее выявим потенциальные проблемы:

**Производительность:**
- Memory leaks при больших файлах → используем streaming
- Блокировка UI при генерации → асинхронная очередь (Redis/Bull)
- Медленный старт Puppeteer → пул браузеров

**Шрифты и локализация:**
- Отсутствие шрифтов на сервере → fallback на системные
- Проблемы с кириллицей → проверка кодировки
- Размер шрифтов → адаптивные размеры

**Надёжность:**
- Таймауты без ретраев → exponential backoff
- Сбои генерации → retry с уведомлением
- Переполнение очереди → rate limiting

**Безопасность:**
- Доступ к данным → проверка ролей
- XSS в HTML → санитизация данных
- Логирование → без PII данных

---

### Шаг 4: Конкретные вопросы стейкхолдерам

**AI:** Сформулирую вопросы для уточнения требований:

**Технические ограничения:**
- Максимальный размер отчёта в страницах/МБ?
- Таймаут генерации (30с, 2мин, 5мин)?
- Количество одновременных экспортов?

**Пользовательский опыт:**
- Нужен ли прогресс-бар в реальном времени?
- Уведомления об ошибках (email, push, in-app)?
- Кэширование готовых отчётов?

**Бизнес-требования:**
- Обязательна ли поддержка мобильных устройств?
- Нужна ли история экспортов?
- Требования к доступности (WCAG)?

**Интеграции:**
- Нужна ли интеграция с внешними сервисами?
- Экспорт в другие форматы (Excel, CSV)?
- API для внешних систем?

---

### Шаг 5: Микро-демо ошибок AI

**Пользователь:** Покажи, какие ошибки может сделать AI по умолчанию.

**AI:** Вот типичные ошибки в моих первоначальных предложениях:

**Ошибка 1: Шрифты без fallback**
```css
/* Плохо */
font-family: 'Roboto', sans-serif;

/* Хорошо */
font-family: 'Roboto', 'Arial', 'Helvetica', sans-serif;
```

**Ошибка 2: Таймауты без ретраев**
```javascript
// Плохо
setTimeout(() => {
    generatePDF();
}, 5000);

// Хорошо
const retryWithBackoff = async (fn, maxRetries = 3) => {
    for (let i = 0; i < maxRetries; i++) {
        try {
            return await fn();
        } catch (error) {
            if (i === maxRetries - 1) throw error;
            await new Promise(resolve => 
                setTimeout(resolve, Math.pow(2, i) * 1000)
            );
        }
    }
};
```

**Ошибка 3: Отсутствие валидации размера**
```javascript
// Плохо
const generatePDF = async (data) => {
    return await puppeteer.generate(data);
};

// Хорошо
const generatePDF = async (data) => {
    if (data.length > MAX_REPORT_SIZE) {
        throw new Error('Report too large');
    }
    return await puppeteer.generate(data);
};
```

---

## Итоговый план

**AI:** На основе диалога предлагаю следующий план:

**MVP (2 спринта):**
1. Базовый экспорт с PDFKit для простых таблиц
2. UI с кнопкой экспорта и базовым прогресс-баром

**Расширение (1 спринт):**
3. Миграция на Puppeteer для сложных отчётов
4. Асинхронная очередь с Redis

**Полировка (1 спринт):**
5. Retry логика и уведомления об ошибках
6. Метрики и мониторинг

**Definition of Done:**
- ✅ Экспорт работает на данных до 50 страниц
- ✅ Время генерации не превышает 30 секунд
- ✅ Поддержка кириллицы и системных шрифтов
- ✅ Обработка ошибок с retry и уведомлениями
- ✅ Логирование без PII данных
- ✅ Тесты на разных типах данных

---

## Выводы

Этот диалог показывает, как AI помогает:
1. **Структурировать хаос** требований в понятный план
2. **Сравнить подходы** с учётом компромиссов
3. **Выявить риски** заранее, а не в продакшене
4. **Сформулировать вопросы** стейкхолдерам
5. **Показать типичные ошибки** и способы их избежать

Результат — не просто код, а продуманное решение с пониманием всех подводных камней.
